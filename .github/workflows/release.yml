name: Build and Deploy Python App

on:
  push:
    branches: ['release']
  pull_request:
    branches: ['release']
  workflow_dispatch:  # Permit manual execution

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      AZURE_MYSQL_USER: ${{ secrets.AZURE_MYSQL_USER }}
      AZURE_MYSQL_PASSWORD: ${{ secrets.AZURE_MYSQL_PASSWORD }}
      AZURE_MYSQL_HOST: ${{ secrets.AZURE_MYSQL_HOST }}
      AZURE_MYSQL_PORT: ${{ secrets.AZURE_MYSQL_PORT }}
      AZURE_MYSQL_DATABASE: ${{ secrets.AZURE_MYSQL_DATABASE }}
      SQLALCHEMY_DATABASE_URL: ${{ secrets.SQLALCHEMY_DATABASE_URL }}

    steps:

      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Print repository status
        run: git log -1

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10.4'  # Adjust Python version as per your requirements

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest

      - name: Log in to Docker Hub
        uses: azure/docker-login@v1
        with:
          login-server: registrytfg.azurecr.io
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Build and push Docker image for Python App
        run: |
          docker build --build-arg AZURE_MYSQL_USER="${AZURE_MYSQL_USER}" \--build-arg AZURE_MYSQL_PASSWORD="${AZURE_MYSQL_PASSWORD}" \--build-arg AZURE_MYSQL_HOST="${AZURE_MYSQL_HOST}" \--build-arg AZURE_MYSQL_PORT="${AZURE_MYSQL_PORT}" \--build-arg AZURE_MYSQL_DATABASE="${AZURE_MYSQL_DATABASE}" \--build-arg SQLALCHEMY_DATABASE_URL="${SQLALCHEMY_DATABASE_URL}" \-t ${{ secrets.AZURE_REGISTRY_SERVER }}/dbapi:release -f Dockerfile --push .
